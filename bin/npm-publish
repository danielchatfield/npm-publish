#!/usr/bin/env node
'use strict';
var argv = require('optimist').argv;
var chalk = require('chalk');
var Insight = require('insight');
var nopt = require('nopt');
var os = require('os');
var pkg = require('../package.json');
var cli = require('../lib/index.js');
var updateNotifier = require('update-notifier');

var run = function() {
  var message = argv.m || argv.message;
  var force = argv.f || argv.force;
  cli.npmPublish(process.argv[2], message, force);
};

var opts = nopt({
  help: Boolean,
  version: Boolean
}, {
  h: '--help',
  v: '--version'
});

var args = opts.argv.remain;

var insight = new Insight({
  trackingCode: 'UA-43097923-1',
  packageName: pkg.name,
  packageVersion: pkg.version
});

if (opts.insight === false) {
  insight.config.set('optOut', true);
} else if (opts.insight) {
  insight.config.set('optOut', false);
}

if (opts.version) {
  return console.log(pkg.version);
}

if (opts.help) {
  return console.log('Refer to http://github.com/danielchatfield/npm-publish/');
}

if (opts['update-notifier'] !== false) {
  var notifier = updateNotifier({
    packagePath: '../package'
  });

  if (notifier.update) {
    if( opts.insight !== false ) {
      insight.track('notify-update');
    }
    notifier.notify(true);
  }
}

if (opts.insight !== false) {
  if (insight.optOut === undefined) {
    insight.optOut = insight.config.get('optOut');
    insight.track('downloaded');
    insight.track('platform', os.type(), os.release() );
    insight.askPermission(chalk.grey('Can we collect anonymous usage data?'), run);
    return;
  }

  insight.track.apply(insight, args.slice(0, 2));
}

run();
